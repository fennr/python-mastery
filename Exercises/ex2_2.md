\[ [Index](index.md) | [Exercise 2.1](ex2_1.md) | [Exercise 2.3](ex2_3.md) \]

# Упражнение 2.2

_Задачи:_

- Работа с различными контейнерами
- Генераторы списков, множеств и словарей
- Модуль collections
- Задача анализа данных

Большинство программистов на Python, как правило, знакомы со списками, словарями, кортежами и другими базовыми типами данных.
В этом упражнении мы применим эту знакомую нам информацию для решения различных задач анализа данных.

## (a) Подготовка

Для начала давайте вспомним основы с простым датасетом из прошлых заданий - портфейлем акций.
Создайте файл `readport.py` со следующим кодом:

```python
# readport.py

import csv

# Функция записывает файл в список словарей
def read_portfolio(filename):
    portfolio = []
    with open(filename) as f:
        rows = csv.reader(f)
        headers = next(rows)
        for row in rows:
            record = {
                'name' : row[0],
                'shares' : int(row[1]),
                'price' : float(row[2])
            }
            portfolio.append(record)
    return portfolio
```

Этот файл считывает некоторые простые данные из файла `Data/portfolio.csv`.
Используйте функцию для чтения файла и посмотрите на результат:

```python
>>> portfolio = read_portfolio('Data/portfolio.csv')
>>> from pprint import pprint
>>> pprint(portfolio)
[{'name': 'AA', 'price': 32.2, 'shares': 100},
 {'name': 'IBM', 'price': 91.1, 'shares': 50},
 {'name': 'CAT', 'price': 83.44, 'shares': 150},
 {'name': 'MSFT', 'price': 51.23, 'shares': 200},
 {'name': 'GE', 'price': 40.37, 'shares': 95},
 {'name': 'MSFT', 'price': 65.1, 'shares': 50},
 {'name': 'IBM', 'price': 70.44, 'shares': 100}]
>>>
```

В этих данных каждая строка представляет собой название акции, количество акций и цену покупки.
Для некоторых акций, таких как MSFT и IBM, есть несколько записей.

## (b) Генераторы

Генераторы списков, множеств и словарей могут быть полезными инструментами для манипуляции с данными.
Попробуйте выполнить следующие операции:

```python
>>> # Найти все акции с количеством больше 100
>>> [s for s in portfolio if s['shares'] > 100]
[{'name': 'CAT', 'shares': 150, 'price': 83.44},
 {'name': 'MSFT', 'shares': 200, 'price': 51.23}]

>>> # Вычислить общую стоимость (количество * цену)
>>> sum([s['shares']*s['price'] for s in portfolio])
44671.15
>>>

>>> # Найти все уникальные имена (исп-ся множество)
>>> { s['name'] for s in portfolio }
{'MSFT', 'IBM', 'AA', 'GE', 'CAT'}
>>>

>>> # Подсчитать общее количество каждой акции
>>> totals = { s['name']: 0 for s in portfolio }
>>> for s in portfolio:
        totals[s['name']] += s['shares']

>>> totals
{'AA': 100, 'IBM': 150, 'CAT': 150, 'MSFT': 250, 'GE': 95}
>>>
```

## (c) Модуль Collections

В модуле `collections` есть классы для специализированных операций с данными.
Например, последний пример можно решить с использованием `Counter`:

```python
>>> from collections import Counter
>>> totals = Counter()
>>> for s in portfolio:
        totals[s['name']] += s['shares']

>>> totals
Counter({'MSFT': 250, 'IBM': 150, 'CAT': 150, 'AA': 100, 'GE': 95})
>>>
```

Counter интересен тем, что он поддерживает и другие операции, такие как ранжирование
и математические операции. Например:

```python
>>> # Получить 2 акции с наибольшим количеством
>>> totals.most_common(2)
[('MSFT', 250), ('IBM', 150)]
>>>

>>> # Cоединить два счетчика
>>> more = Counter()
>>> more['IBM'] = 75
>>> more['AA'] = 200
>>> more['ACME'] = 30
>>> more
Counter({'AA': 200, 'IBM': 75, 'ACME': 30})
>>> totals
Counter({'MSFT': 250, 'IBM': 150, 'CAT': 150, 'AA': 100, 'GE': 95})
>>> totals + more
Counter({'AA': 300, 'MSFT': 250, 'IBM': 225, 'CAT': 150, 'GE': 95, 'ACME': 30})
>>>
```

`defaultdict` можно использовать для группировки данных.
Предположим, что вы хотите найти все записи с определенным названием, например IBM.
Попробуйте следующий код:

```python
>>> from collections import defaultdict
>>> byname = defaultdict(list)
>>> for s in portfolio:
        byname[s['name']].append(s)

>>> byname['IBM']
[{'name': 'IBM', 'shares': 50, 'price': 91.1}, {'name': 'IBM', 'shares': 100, 'price': 70.44}]
>>> byname['AA']
[{'name': 'AA', 'shares': 100, 'price': 32.2}]
>>>
```

Ключевая особенность, заключается в том, что `defaultdict` автоматически инициализирует элементы,
что позволяет объединить операции вставки нового элемента и добавления с помощью `append()`.

## (c) Задача анализа данных

В [предыдущем упражнении](ex2_1.md) вы написали код для чтения данных в формате CSV.
Например, вы можете получить данные в виде словарей вот так:

```python
>>> import readrides
>>> rows = readrides.read_rides_as_dicts('Data/ctabus.csv')
>>>
```

Было бы неправильно проделать эту работу и ничего не сделать с данными.

В этом упражнении ваша задача заключается в следующем: напишите программу, чтобы ответить на следующие четыре вопроса:

1. Сколько автобусных маршрутов существует в Чикаго?

2. Сколько человек проехало на автобусе номер 22 2 февраля 2011 года? А что насчет любого маршрута в любой выбранный вами день?

3. Сколько всего пассажиров проехали на каждом маршруте?

4. Какие пять маршрутов за 10 лет имели наибольший прирост пассажиров от 2001 года до 2011 года?

Вы можете использовать любую технику для ответа на эти вопросы, пока она является частью стандартной библиотеки Python
(т.е. встроенные типы данных, модули стандартной библиотеки и т.д.).

\[ [Solution](soln2_2.md) | [Index](index.md) | [Exercise 2.1](ex2_1.md) | [Exercise 2.3](ex2_3.md) \]

---

`>>>` Advanced Python Mastery  
`...` A course by [dabeaz](https://www.dabeaz.com)  
`...` Copyright 2007-2023

![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png). This work is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/)
